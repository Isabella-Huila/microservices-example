server {
    # Recomendación: Escuchar solo en el puerto 80 dentro del contenedor,
    # ya que el mapeo de Docker (8080:80) se encarga del resto.
    listen 80;
    server_name localhost;

    # Servir archivos estáticos del frontend (Vue)
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # Proxy para Auth API (Go)
    location /api/auth/ {
        # Este ya estaba correcto
        proxy_pass http://auth-api:8000/;
        proxy_ssl_server_name on;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Proxy para TODOs API (NodeJS)
    location /api/todos/ {
        # CORREGIDO: Apuntar al puerto 8082
        proxy_pass http://todos-api:8082/;
        proxy_set_header Host $host;
    }

    # Proxy para Users API (Java)
    location /api/users/ {
        # CORREGIDO: Apuntar al puerto 8083
        proxy_pass http://users-api:8083/;
        proxy_set_header Host $host;
    }

    # Proxy para Zipkin
    location /zipkin/ {
        # Elimina la expresión regular y la variable $1.
        # Cuando se usa una URI en proxy_pass, Nginx reemplaza
        # la parte de la URL que coincide con 'location'.
        proxy_pass http://zipkin:9411/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}